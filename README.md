# BandWidthTool

## 实现方法的权衡

- 通常来说，带宽预测的实现方式是通过下载数据量除以消耗时间的方式来计算。用这种方法计算的带宽是响应时间内的平均带宽，当段长较长时，该方法不能很好的捕捉到实际带宽的快速变化，造成预估带宽和实际带宽不匹配。

- 基于传输层参数，如往返时延 RTT、丢包率等来计算可用带宽，该方法可以较为精准的检测到当前网络环境，但需要深入传输层做控制，实现复杂。

- 为了平衡平均带宽方法与传输层参数方法，有一种基于抽样带宽的估测方法，通过对下载数据等长时间抽样，在段内采用平均带宽方法计算多个带宽抽样值，然后通过这些抽样值序列进行带宽预估。但该方法对细小的网络波动敏感，会造成不必要的带宽预估值波动。

- 为了解决这些问题，参考[这篇文章](http://www.shcas.net/jsjyup/pdf/2017/3/%E4%B8%80%E7%A7%8D%E6%94%B9%E8%BF%9B%E7%9A%84HTTP%E8%87%AA%E9%80%82%E5%BA%94%E6%B5%81%E5%B8%A6%E5%AE%BD%E4%BC%B0%E8%AE%A1%E6%96%B9%E6%B3%95.pdf)中的方法。该方法包括段内估测和段间估测与段内估测。段内估测通过指数平均方法平滑段内抽样带宽序列求得该段的即时带宽； 通过逻辑斯谛方程预测即时带宽的变化值来求得下一段的估测带宽。文章中有详细的实现思路。

## 实现应保持的原则
- 应迅速的捕捉到网络环境的变化，并弱化较小的网络波动时的预估，快速跟随较大的网络波动迅速响应。

## 实现
1. 段内估测当前带宽
步骤：
- 当资源段时长 < videoDurationThreshold（自定义） 时，当前带宽 = 资源总大小 / 下载总时长；
- 当资源段时长 > videoDurationThreshold 时，对下载数据等长时间采样（videoIntervalValue 采样间隔），在段内采用平均带宽方法计算多个带宽抽样值，并用指数平均方法来平滑段内抽样带宽序列。抽样序列的最后一个指数平均值作为当前可用带宽。既：当前带宽 = （当前段落上一次采样次数 * 上一次的平均带宽 + 2 * 上一次采样的指数带宽）/ 下一次采样次数。

2. 段间估测下一段资源的带宽
- 在当前即时带宽的基础上增加一个，网络波动的预估值。既：下一段预估带宽 = 当前即时带宽 + 变化值；
- 即时带宽是已知的，波动值 =  (本段预估带宽 - 本段即时带宽)， 变化值 =  波动值 * 修正值；
- 修正值的取值范围为 0~1 之间，为了快速跟随较大的网络波动，修正值应该更趋向 0，为了平滑较小的网络波动，修正值应该更趋向1。修正值依赖于波动值，这里使用逻辑斯谛方程来建立波动值与修正值间的控制函数：


## License

`BandWidthTool` is available under the MIT license.
